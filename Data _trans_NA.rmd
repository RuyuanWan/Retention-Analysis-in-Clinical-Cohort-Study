---
title: "Data_Transforamtion"
output: word_document
---
#Recommendation: Set the working directory in a way where the data files can be read easily.

setwd("")

```{r read_data, echo = FALSE, printMessages = FALSE}
#upload datasets
setwd('/Ruyuan/Raw Data')
Genetic <- read.csv('C:/Users/namondikar/Downloads/Ruyuan/Raw Data/Genetic.csv', 
                  header=TRUE)
head(Genetic)
Users<-read.csv("C:/Users/namondikar/Downloads/Ruyuan/Raw Data/Users.csv",header=TRUE)
head(Users)

EEQ_alcohol<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_alcohol.csv")
EEQ_anti_inflammatory<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_Anti_Inflammatory_Medication_History.csv")
EEQ_caffeine<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_caffeine.csv")
EEQ_calcium<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_calcium_channel_blocker_medication_history.csv")
EEQ_female<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_female_reproductive_health.csv")
EEQ_height_weight<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_height_and_weight.csv")
EEQ_occupation<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_occupation.csv")
EEQ_pesticides<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_pesticides_at_work.csv")
EEQ_physical<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_physical_activity.csv")
EEQ_residential<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_residential.csv")
EEQ_smoking<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_smoking.csv")
EEQ_toxicant<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/EEQ_toxicant.csv")

financial_social<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/Financial_and_Social_Impact_of_Parkinsons_Disease.csv")
impact_communication<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/Impact_and_Communication_about_OFF_Periods.csv")
Therapeutic<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/Patient_Therapeutic_Preferences_Questionnaire.csv")
Understanding_OFF_ON<-read.csv("C:/Users/respartintern2/OneDrive - The Michael J. Fox Foundation for Parkinson's Research/Ruyuan/Raw Data/onetime_1pt_each/Understanding_OFF_and_ON_in_Parkinsons_Patients.csv")

return_PD <- read.csv("C:/Users/namondikar/Downloads/Ruyuan/Raw Data/longitudinal_1pt_each/ReturnPD.csv",
                      stringsAsFactors = FALSE)
return_CTR <- read.csv("C:/Users/namondikar/Downloads/Ruyuan/Raw Data/longitudinal_1pt_each/ReturnCTR.csv",
                      stringsAsFactors = FALSE)

```


```{r recode_1, echo = FALSE}
Users_transform <- Users %>%
  mutate(fox_insight_id = as.character(fox_insight_id)) %>%
  add_column(ltv = NA)

#ID <- as.character(Users$fox_insight_id)

#create an empty vector to store life time value
#ltv<-as.numeric(vector( ,length(Users$fox_insight_id)))
#create a data frame that have variables participant ID and life time value
#LTV<-cbind.data.frame(ID,ltv)
#head(LTV)
#the initial life time value is 0
```

The following code chunk joins the Genetic and the Users table, and then for all users who have Genetic data 10 points are added to LTV.

Known discrepencies in the dataset are identified, and filtered out.
```{r}
#First, join the Users and the Genetic tables together in a temporary DF
users_genetic <- Users_transform %>%
  mutate(fox_insight_id = as.character(fox_insight_id)) %>%
  mutate(ltv = case_when(fox_insight_id %in% Genetic$fox_insight_id ~ 10,
                         TRUE ~ 0)) %>%
  write.csv("LTV_gene.csv", row.names = FALSE)

#Checking whether all subjects in the Genetic dataset have corresponding demographics data in the Users table
Genetic_test <- Genetic %>%
  mutate(id_check = case_when(fox_insight_id %in% Users$fox_insight_id ~ 'TRUE', 
                              TRUE ~ 'FALSE'))


# Add 1 point if the participant have genetic information
i=2

for (j in 1:38588)
{  # break the loop when last particant who has genetic information has been added 1 point
   if (i==2152){ 
      break
   }
   #If the participants who are in the registration list and have genetic information, then add 1 point to them
   else if ( Genetic$fox_insight_id[i] == LTV$ID[j]) {
        LTV$ltv[j] = 10
        i=i+1
        next
   }
   # participants whose index are 60,137,651,1495 in the genetic dataset were not recorded at "users" dataset 
   else if (i ==60 ||i == 137|| i==651 || i == 1495) {
      i=i+1
      next
   }
}

head(LTV)
(i)

```

```{r write_genetic, echo = FALSE}
write.csv(LTV,"LTV_Gene.csv")
```


```{r return_points, echo = FALSE}
#count the frequency of return visit for PD group
returnPD_points<-as.data.frame(table(returnPD$fox_insight_id))
head(returnPD_points)

returnPD_points <- return_PD %>%
  group_by(fox_insight_id) %>%
  summarise(freq_obs = n())

#count the frequency of return visit for control group
returnCTR_points<-as.data.frame(table(returnCTR$fox_insight_id))
head(returnCTR_points)

returnCTR_points <- return_CTR %>%
  group_by(fox_insight_id) %>%
  summarise(freq_obs = n())

#Next steps: 
#1. join the two return tables for a master return table
#2. Left join on Users_transform with the return master table (this allows transfering the "Freq_obs" value to the LTV value)
#3. Make sure all numeric columns are encoded as such
#4. mutate(Ltv = ltv + freq_obs)
```


```{r}
m=1
n=1
#Each longitudinal visit window = 1 point
for (j in 1:38588)
{  #break the loop when all returned visits has been added points
   if (m==24570) {
         break
}
   #1 time return = 1 point
   else if ( returnPD_points$Var1[m] == LTV$ID[j]) {
        LTV$ltv[j] = LTV$ltv[j] + returnPD_points$Freq[m] 
        m=m+1
        next
   }
   if (n == 9175){
         break
   }
   else if (returnCTR_points$Var1[n] == LTV$ID[j]) {
        LTV$ltv[j] = LTV$ltv[j] + returnCTR_points$Freq[n] 
        n=n+1
        next
   }
}
```
```{r}
write.csv(LTV,"LTV_Return.csv")
```

# Each one-time questionnaire, and sub-study = 1 point
#EEQ_alcohol
```{r}
i=1 
for (j in 1:38588)
{ 
   if (i==2816) {
         break
   }
   else if ( EEQ_alcohol$fox_insight_id[i] == LTV$ID[j]) {
        LTV$ltv[j] = LTV$ltv[j] + 1
        i=i+1
        next
   }
   # repeated one-time questionares 
   else if (i %in% c(30,65,114,208,841,892,934,1033,1068,1342,1344,1388,1920,1970,2320,2343,2465,2677,2715)) {
      i=i+1
      next
   }
}

```
#EEQ_Anti_Inflammatory
```{r}
i=1 
m=296
for (j in 1:38588)
{ 
   if (i==3589) {
         break
   }
   else if ( EEQ_anti_inflammatory$fox_insight_id[i] == LTV$ID[j]) {
        LTV$ltv[j] = LTV$ltv[j] + 1
        i=i+1
        m= i - 1
        next
   }
   # repeated one-time questionares 
   else if (EEQ_anti_inflammatory$fox_insight_id[i] == EEQ_anti_inflammatory$fox_insight_id[m]){
        i = i+1      
        next
   }
}

```
#EEQ_caffeine
```{r}
i=1 
for (j in 1:38588)
{ 
   if (i==6004) {
         break
   }
   else if ( EEQ_caffeine$fox_insight_id[i] == LTV$ID[j]) {
        LTV$ltv[j] = LTV$ltv[j] + 1
        i=i+1
        print(j)
        next
   }
   # repeated one-time questionares 
   else if (i %in% c(48,112,117,138)) {
      i=i+1
      next
   }
}

```
















































































































